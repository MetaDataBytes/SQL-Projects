CREATE TABLE ORDER_LINE(
	ORDER_LINE_ID INT IDENTITY(0, 1) PRIMARY KEY,
	ORDER_ID INT NOT NULL FOREIGN KEY REFERENCES "ORDER"(ORDER_ID_INT) ON DELETE CASCADE ON UPDATE CASCADE,
	PRODUCT_ID INT NOT NULL FOREIGN KEY REFERENCES PRODUCT(PRODUCT_ID_INT) ON DELETE CASCADE ON UPDATE CASCADE
)
GO

DECLARE @MAX_QUANTITY INT = (SELECT MAX(QUANTITY) FROM STAGING_TABLE);

WITH QUANTITY AS (
    SELECT 1 AS Q_COUNT
    UNION ALL
    SELECT Q_COUNT + 1
    FROM QUANTITY
    WHERE Q_COUNT < @MAX_QUANTITY
),

-- Step 2: Generate the Duplicated Rows
DuplicatedRows AS (
    SELECT 
        ORDER_ID,
        PRODUCT_ID
    FROM STAGING_TABLE A
    JOIN QUANTITY B ON A.QUANTITY <= B.Q_COUNT
)

-- Step 3: Insert the Results into the ORDER_LINE Table
INSERT INTO ORDER_LINE
SELECT 
	ORDER_ID_INT,
	PRODUCT_ID_INT
FROM DuplicatedRows A
INNER JOIN "ORDER" B ON A.ORDER_ID = B.ORDER_ID
INNER JOIN PRODUCT C ON A.PRODUCT_ID = C.PRODUCT_ID
ORDER BY ORDER_ID_INT, PRODUCT_ID_INT
OPTION (MAXRECURSION 0)