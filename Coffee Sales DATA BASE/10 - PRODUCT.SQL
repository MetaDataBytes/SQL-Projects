CREATE TABLE PRODUCT(
	PRODUCT_ID_INT INT IDENTITY(0, 1) PRIMARY KEY,
	PRODUCT_ID VARCHAR(100) NOT NULL,
	COFFEE_TYPE_ID INT NOT NULL FOREIGN KEY REFERENCES COFFEE_TYPE(COFFEE_TYPE_ID) ON DELETE CASCADE ON UPDATE CASCADE,
	ROAST_TYPE_ID INT NOT NULL FOREIGN KEY REFERENCES ROAST_TYPE(ROAST_TYPE_ID) ON DELETE CASCADE ON UPDATE CASCADE,
	UNIT_SIZE INT NOT NULL,
	UNIT_PRICE DECIMAL(5, 2) NOT NULL,
	COST_PER_100G DECIMAL(5, 2) NOT NULL,
	PROFIT AS CAST(UNIT_PRICE - (COST_PER_100G / (100 / CAST(UNIT_SIZE AS FLOAT))) AS DECIMAL(5,2))
)

INSERT INTO PRODUCT
SELECT DISTINCT
	UPPER(TRIM(PRODUCT_ID)) AS PRODUCT_ID,
	COFFEE_TYPE_ID,
	ROAST_TYPE_ID,
	CAST(CAST(UNIT_SIZE AS DECIMAL(5,2)) * 100 AS INT) AS UNIT_SIZE,
	CAST(UNIT_PRICE AS DECIMAL(5, 2)) AS UNIT_PRICE,
	CAST(COST_PER_100G AS DECIMAL(5, 2)) AS COST_PER_100G
FROM STAGING_TABLE A
INNER JOIN(
	SELECT 
		COFFEE_TYPE_ID,
		CASE 
			WHEN UPPER(COFFEE_TYPE) = 'ARABICA' THEN 'ARA'
			WHEN UPPER(COFFEE_TYPE) = 'EXCELSA' THEN 'EXC'
			WHEN UPPER(COFFEE_TYPE) = 'LIBERICA' THEN 'LIB'
			WHEN UPPER(COFFEE_TYPE) = 'ROBUSTA' THEN 'ROB'
			ELSE UPPER(COFFEE_TYPE)
		END AS COFFEE_TYPE
	FROM COFFEE_TYPE
) B ON UPPER(A.COFFEE_TYPE) = B.COFFEE_TYPE
INNER JOIN(
	SELECT
		ROAST_TYPE_ID,
		CASE
			WHEN UPPER(ROAST_TYPE) = 'DARK' THEN 'D'
			WHEN UPPER(ROAST_TYPE) = 'MEDIUM' THEN 'M'
			WHEN UPPER(ROAST_TYPE) = 'LIGHT' THEN 'L'
			ELSE UPPER(ROAST_TYPE)
		END AS ROAST_TYPE
	FROM ROAST_TYPE
) C ON UPPER(A.ROAST_TYPE) = C.ROAST_TYPE
ORDER BY COFFEE_TYPE_ID, ROAST_TYPE_ID, UNIT_SIZE