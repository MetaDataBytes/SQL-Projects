CREATE TABLE COFFEE_SALES_FACT_TABLE(
	DIM_CUSTOMER_ID INT NOT NULL FOREIGN KEY REFERENCES DIM_CUSTOMER(DIM_CUSTOMER_ID) ON DELETE CASCADE ON UPDATE CASCADE,
	DIM_ORDER_ID INT NOT NULL FOREIGN KEY REFERENCES DIM_ORDER(DIM_ORDER_ID) ON DELETE CASCADE ON UPDATE CASCADE,
	DIM_PRODUCT_ID INT NOT NULL FOREIGN KEY REFERENCES DIM_PRODUCT(DIM_PRODUCT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
	COST_PER_100G DECIMAL(5,2) NOT NULL,
	UNIT_SIZE INT NOT NULL,
	UNIT_PRICE DECIMAL(5,2) NOT NULL,
	UNIT_COST AS CAST(COST_PER_100G / (100 / CAST(UNIT_SIZE AS FLOAT)) AS DECIMAL(5,2)),
	UNIT_PROFIT AS CAST(UNIT_PRICE - (COST_PER_100G / (100 / CAST(UNIT_SIZE AS FLOAT))) AS DECIMAL(5,2)),
	QUANTITY INT NOT NULL,
	ORDER_LINE_PRICE AS UNIT_PRICE * QUANTITY,
	ORDER_LINE_COST AS CAST(((COST_PER_100G / (100 / CAST(UNIT_SIZE AS FLOAT))) * QUANTITY) AS DECIMAL(5,2)),
	ORDER_LINE_PROFIT AS CAST(((UNIT_PRICE - (COST_PER_100G / (100 / CAST(UNIT_SIZE AS FLOAT)))) * QUANTITY) AS DECIMAL(5,2))
)

INSERT INTO COFFEE_SALES_FACT_TABLE
SELECT DISTINCT
	CUSTOMER_ID AS DIM_CUSTOMER_ID,
	A.ORDER_ID AS DIM_ORDER_ID,
	B.PRODUCT_ID AS DIM_PRODUCT_ID,
	COST_PER_100G,
	UNIT_SIZE,
	UNIT_PRICE,
	QUANTITY
FROM COFFEE_SALES.DBO."ORDER" A
INNER JOIN COFFEE_SALES.DBO.ORDER_LINE B ON A.ORDER_ID = B.ORDER_ID
INNER JOIN COFFEE_SALES.DBO.PRODUCT C ON B.PRODUCT_ID = C.PRODUCT_ID
WHERE NOT EXISTS(
	SELECT 1
	FROM COFFEE_SALES_FACT_TABLE
	WHERE A.CUSTOMER_ID = DIM_CUSTOMER_ID
	AND A.ORDER_ID = DIM_ORDER_ID
	AND B.PRODUCT_ID = DIM_PRODUCT_ID
)